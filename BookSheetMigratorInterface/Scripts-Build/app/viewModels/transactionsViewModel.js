define(["knockout","app/viewModels/transactionViewModel","app/bindings/isLoadingWhen","app/bindings/pagination","app/utilities/utilities","signalr.hubs"],function(e,t){return function(){function s(t){var n=[];return e.utils.arrayForEach(t,function(e){e.importable()&&e.isValidImport()&&n.push({eventId:e.eventId,transactionId:e.transactionId})}),n}function o(e){if(e.length===0)return;$.ajax({url:i+"import",type:"POST",data:JSON.stringify(e),dataType:"json",contentType:"application/json",success:function(e){r.isNotImporting(!0),u(e)}})}function u(e){e.forEach(function(e){r.transactions().some(function(t){return t.equals(e)?(t.showImportResultAndRemove(e.result,r.transactions),!0):!1})})}function a(){return e.utils.arrayFilter(r.transactions(),function(e){return e.isSelected()})}function f(t){var n=[];return e.utils.arrayForEach(t,function(e){e.updateable()&&e.isValidateUpdate()&&n.push({eventId:e.eventId,transactionId:e.transactionId,sellerDealerId:e.sellerDealerId(),buyerDealerId:e.buyerDealerId(),buyerContactId:e.buyerContactId(),bidAmount:e.bidAmount(),transportFee:e.transportFee(),soldDate:e.soldDate(),feeException:e.feeException()})}),n}function l(e){if(e.length===0)return;$.ajax({url:i+"bulk-update",type:"PUT",data:JSON.stringify(e),dataType:"json",contentType:"application/json",success:function(e){c(e)}})}function c(e){e.forEach(function(e){r.transactions().some(function(t){return t.equals(e)?(t.showUpdateResult(e.result),!0):!1})})}function p(){h.server.getUnimported().done(function(e){var n=$.map(e.unimported,function(e){return new t(e,i)});r.isLoadingTransactions(!1),r.feeExceptions=e.feeExceptions,r.transactions(n)}).fail(function(e,t,n){r.error(n)})}var r=this;r.transactions=e.observableArray([]),r.error=e.observable(),r.hasTransactions=e.computed(function(){return r.transactions().length>0}),r.feeExceptions=[],r.filter=e.observable(""),r.showOnlyNew=e.observable(!1),r.isNotImporting=e.observable(!0),r.filteredTransactions=e.computed(function(){var t=r.filter().toLowerCase();if(!t&&!r.showOnlyNew())return r.transactions();var n=r.transactions();return r.showOnlyNew()&&(n=e.utils.arrayFilter(n,function(e){return e.newlyAdded()})),t&&(n=e.utils.arrayFilter(n,function(e){return e.vin.toLowerCase().contains(t)})),n}),r.toggleShowOnlyNew=function(){r.showOnlyNew(!r.showOnlyNew())},r.showOnlyNew=e.observable(!1),r.newCount=e.computed(function(){var t=e.utils.arrayFilter(r.transactions(),function(e){return e.newlyAdded()});return t.length}),r.filterTypeCount=e.computed(function(){return r.showOnlyNew()?r.transactions().length:r.newCount()}),r.filterTypeText=e.computed(function(){return r.showOnlyNew()?"All":"New"}),r.hasNew=e.computed(function(){return r.newCount()>0}),r.isLoadingTransactions=e.observable(!0),r.itemCount=e.computed(function(){return r.filteredTransactions().length}),r.perPage=e.observable(10),r.pageIndex=e.observable(0),r.page=e.computed(function(){var e=r.pageIndex()*r.perPage();return r.filteredTransactions().slice(e,e+r.perPage())}),r.fadeIn=function(e){$(e).hide(),$(e).fadeIn(250)};var i="/api/Transaction/";r.selectAll=function(){e.utils.arrayForEach(r.page(),function(e){e.isSelected(!0)})},r.selectNone=function(){e.utils.arrayForEach(r.page(),function(e){e.isSelected(!1)})},r.importSelected=function(){var e=a();if(e.length===0)return;r.isNotImporting(!1);var t=s(e);o(t)},r.updateSelected=function(){var e=a(),t=f(e);l(t)};var h=$.connection.transactionTicker;h.client.consumeNewTransactions=function(e){$.each(e,function(e,n){var s=new t(n,i);s.newlyAdded(!0),r.transactions.push(s)})},$.connection.hub.logging=!0,$.connection.hub.start().done(p)}});